version: '3.9'

services:
  app:
    build: .
    image: fleet-backend:latest
    container_name: fleet-backend
    environment:
      - PORT=8080
      - MONGO_URI=${MONGO_URI:-mongodb://mongo:27017}
      - MONGO_DB=${MONGO_DB:-fleet}
      - JWT_SECRET=${JWT_SECRET}
      - TELEMETRY_TTL_DAYS=${TELEMETRY_TTL_DAYS:-30}
      - MQTT_BROKER_URL=${MQTT_BROKER_URL:-tcp://mosquitto:1883}
      - MQTT_TELEMETRY_TOPIC=${MQTT_TELEMETRY_TOPIC:-fleet/telemetry}
      - WEBSOCKETS_ENABLED=${WEBSOCKETS_ENABLED:-true}
    depends_on:
      - mongo
      - mosquitto
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:8080/api/telemetry" ]
      interval: 30s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - REACT_APP_API_URL=${REACT_APP_API_URL:-http://app:8080}
    image: fleet-frontend:latest
    container_name: fleet-frontend
    ports:
      - "3000:80"
    depends_on:
      - app
    restart: unless-stopped

  mongo:
    image: mongo:6.0
    container_name: fleet-mongo
    volumes:
      - mongo_data:/data/db
    restart: unless-stopped

  mosquitto:
    image: eclipse-mosquitto:2
    container_name: fleet-mosquitto
    ports:
      - "1883:1883"
    volumes:
      - ./configs/mosquitto:/mosquitto/config
    restart: unless-stopped

volumes:
  mongo_data:
